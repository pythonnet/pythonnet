version: '{branch}-{build}'
build: off

platform:
  - x86
  - x64

environment:
  global:
    PYTHONUNBUFFERED: True
    PYTHONWARNINGS: 'ignore:::wheel.pep425tags:'
    PYTHONPATH: C:\testdir
    NUNIT: nunit-console
    CONDA_BLD: C:\conda
    CONDA_BLD_VERSION: 3.5

    # SDK v7.0 MSVC Express 2008's SetEnv.cmd script will fail if the
    # /E:ON and /V:ON options are not enabled in the batch script interpreter
    # See: http://stackoverflow.com/a/13751649/163740
    CMD_IN_ENV: 'cmd /E:ON /V:ON /C .\ci\run_with_env.cmd'

  matrix:
    - PYTHON_VERSION: 2.7
    - PYTHON_VERSION: 3.3
    - PYTHON_VERSION: 3.4
    - PYTHON_VERSION: 3.5
    - PYTHON_VERSION: 3.6

init:
  # Prepare environment
  - mkdir C:\testdir

  # Set environment variables depending based on build cfg
  - set CONDA_PY=%PYTHON_VERSION:.=%
  - set CONDA_BLD_ARCH=%PLATFORM:x=%
  - set PYTHON=C:\PYTHON%PYTHON_VERSION:.=%
  - if %PLATFORM%==x86 (set CONDA_BLD_ARCH=32)
  - if %PLATFORM%==x86 (set NUNIT=%NUNIT%-x86)
  - if %PLATFORM%==x64 (set PYTHON=%PYTHON%-x64)

  # Prepend newly installed Python to the PATH of this build
  - set PATH=%PYTHON%;%PYTHON%\Scripts;%PATH%

  # Check that we have the expected version, architecture for Python
  - python --version
  - python -c "import struct; print(struct.calcsize('P') * 8)"
  - python -c "import ctypes; print(ctypes.sizeof(ctypes.c_wchar))"

install:
  # install conda and deps
  - ps: .\ci\install_miniconda.ps1

  # install for wheels
  - pip install --upgrade pip wheel six

build_script:
  # build clean sdist & wheel
  - python setup.py sdist bdist_wheel

  # build and dist conda package
  - '%CMD_IN_ENV% %CONDA_BLD%\Scripts\conda build conda.recipe'
  - ps: $CONDA_PKG=(&"$env:CONDA_BLD\Scripts\conda" build conda.recipe --output -q)
  - ps: Copy-Item $CONDA_PKG "$env:APPVEYOR_BUILD_FOLDER\dist\"

test_script:
  - pip install --no-index --find-links=.\dist\ pythonnet
  - ps: Copy-Item (Resolve-Path .\build\*\Python.Test.dll) C:\testdir
  - python src\tests\runtests.py
  # - "%NUNIT% src/embed_tests/bin/%PLATFORM%/ReleaseWin/Python.EmbeddingTest.dll"

artifacts:
  - path: dist\*
